import{_ as d,c as r,J as a,m as i,a as s,w as l,V as n,E as h,o as g}from"./chunks/framework.WH0rnJL5.js";const P=JSON.parse('{"title":"1.28.2 升级和更新的操作步骤","description":"","frontmatter":{"tags":["计算机/操作系统/Linux","操作系统/Debian","操作系统/Debian/Debian-11","操作系统/Unix","运维/云原生/Kubernetes/K8s","运维/云原生/Kubernetes","命令行/kubectl","软件/云原生/kubectl","命令行/kubeadm","软件/云原生/kubeadm","软件/云原生/kubelet","命令行/apt","计算机/网络/Cilium","运维/Cilium","命令行/cilium","软件/云原生/Cilium"]},"headers":[],"relativePath":"笔记/🧱 基础设施/🚢 Kubernetes/Kubernetes 集群的日常升级和更新/1.28.2 升级和更新的操作步骤.md","filePath":"笔记/🧱 基础设施/🚢 Kubernetes/Kubernetes 集群的日常升级和更新/1.28.2 升级和更新的操作步骤.md"}'),o={name:"笔记/🧱 基础设施/🚢 Kubernetes/Kubernetes 集群的日常升级和更新/1.28.2 升级和更新的操作步骤.md"},c=i("h1",{id:"_1-28-2-升级和更新的操作步骤",tabindex:"-1"},[s("1.28.2 升级和更新的操作步骤 "),i("a",{class:"header-anchor",href:"#_1-28-2-升级和更新的操作步骤","aria-label":'Permalink to "1.28.2 升级和更新的操作步骤"'},"​")],-1),y=n(`<h2 id="先决条件" tabindex="-1">先决条件 <a class="header-anchor" href="#先决条件" aria-label="Permalink to &quot;先决条件&quot;">​</a></h2><h3 id="检查-kubelet-kubeadm-和-kubectl-的依赖状态" tabindex="-1">检查 <code>kubelet</code>，<code>kubeadm</code> 和 <code>kubectl</code> 的依赖状态 <a class="header-anchor" href="#检查-kubelet-kubeadm-和-kubectl-的依赖状态" aria-label="Permalink to &quot;检查 \`kubelet\`，\`kubeadm\` 和 \`kubectl\` 的依赖状态&quot;">​</a></h3><p>我们先检查一下当前依赖对应的 Repository 配置是否正确：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> apt info kubelet</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> apt info kubeadm</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> apt info kubectl</span></span></code></pre></div><p>一般而言，1.28 的集群对应的 <code>apt</code> Repository 应该都是</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>https://pkgs.k8s.io/core:/stable:/v1.28/deb</span></span></code></pre></div><p>如果确定 <code>apt</code> 的 Repository 是预期内的结果，比如下面这样：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo apt info kubectl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Package:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Version:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1.28</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.4-1.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Priority:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> optional</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Section:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> admin</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Maintainer:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Kubernetes Authors </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">dev@kubernetes.i</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">o</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Installed-Size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 49.9</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> MB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Homepage:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https://kubernetes.io</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Download-Size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> MB</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">APT-Sources:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https://pkgs.k8s.io/core:/stable:/v1.28/deb  Packages</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Description:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Command-line utility for interacting with a Kubernetes cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> Command-line</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> utility for interacting with a Kubernetes cluster.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">N:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 有 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 条附加记录。请加上 ‘-a’ 参数来查看它们</span></span></code></pre></div><p>那么我们再继续。</p><h2 id="升级第一个控制平面节点的-kubeadm" tabindex="-1">升级第一个控制平面节点的 <code>kubeadm</code> <a class="header-anchor" href="#升级第一个控制平面节点的-kubeadm" aria-label="Permalink to &quot;升级第一个控制平面节点的 \`kubeadm\`&quot;">​</a></h2>`,12),F=n(`<h3 id="准备-kubeadm-升级计划" tabindex="-1">准备 <code>kubeadm</code> 升级计划 <a class="header-anchor" href="#准备-kubeadm-升级计划" aria-label="Permalink to &quot;准备 \`kubeadm\` 升级计划&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm upgrade plan</span></span></code></pre></div><p>它会有这样的输出</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubeadm upgrade plan</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/config] Making sure the configuration is correct:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/config] Reading configuration from the cluster...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/config] FYI: You can look at this config file with </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[preflight] Running pre-flight checks.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade] Running cluster health checks</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade] Fetching available versions to upgrade to</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/versions] Cluster version: v1.28.0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/versions] kubeadm version: v1.28.4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/versions] Target version: v1.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">W1201</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 12</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:27:33.656466    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4866</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> version.go:104] could not fetch a Kubernetes version from the internet: unable to get URL &quot;https://dl.k8s.io/release/stable-1.28.txt&quot;: Get &quot;https://cdn.dl.k8s.io/release/stable-1.28.txt&quot;: EOF</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">W1201</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 12</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:27:33.656531    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4866</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> version.go:105] falling back to the local client version: v1.28.4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/versions] Latest version </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> the v1.28 series: v1.28.4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">W1201</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 12</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:27:34.039994    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4866</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps &quot;kube-proxy&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> not found</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Components</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> that must be upgraded manually after you have upgraded the control plane with &#39;kubeadm upgrade apply&#39;:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">COMPONENT</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   CURRENT       TARGET</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubelet</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> x v1.28.2   v1.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">            1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> x v1.28.4   v1.28.4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Upgrade</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to the latest version in the v1.28 series:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">COMPONENT</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                 CURRENT   TARGET</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-apiserver</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            v1.28.0   v1.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-controller-manager</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   v1.28.0   v1.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-scheduler</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            v1.28.0   v1.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-proxy</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                v1.28.0   v1.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">CoreDNS</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                   v1.10.1   v1.10.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">etcd</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                      3.5</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.9-0   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3.5</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.9-0</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">You</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> can now apply the upgrade by executing the following command:</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">	kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> upgrade apply v1.28.4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">_____________________________________________________________________</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">The</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> table below shows the current state of component configs as understood by this version of kubeadm.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Configs</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> that have a &quot;yes&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mark in the &quot;MANUAL UPGRADE REQUIRED&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> column require manual config upgrade or</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">resetting</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to kubeadm defaults before a successful upgrade can be performed. The version to manually</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">upgrade</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to is denoted in the &quot;PREFERRED VERSION&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> column.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">API</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> GROUP                 CURRENT VERSION   PREFERRED VERSION   MANUAL UPGRADE REQUIRED</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubeproxy.config.k8s.io</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   -                 v1alpha1            no</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubelet.config.k8s.io</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     v1beta1           v1beta1             no</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">_____________________________________________________________________</span></span></code></pre></div><p>准备无误之后就可以升级了。</p><h3 id="应用-kubeadm-升级" tabindex="-1">应用 <code>kubeadm</code> 升级 <a class="header-anchor" href="#应用-kubeadm-升级" aria-label="Permalink to &quot;应用 \`kubeadm\` 升级&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm upgrade apply v1.28.4</span></span></code></pre></div><p>输出就像这样：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubeadm upgrade apply v1.28.4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/config] Making sure the configuration is correct:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/config] Reading configuration from the cluster...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/config] FYI: You can look at this config file with </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">W1201</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 12</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:29:14.365811    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">5109</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps &quot;kube-proxy&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> not found</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[preflight] Running pre-flight checks.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade] Running cluster health checks</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/version] You have chosen to change the cluster version to </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;v1.28.4&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/versions] Cluster version: v1.28.0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/versions] kubeadm version: v1.28.4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade] Are you sure you want to proceed</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [y/N]: y</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/prepull] Pulling images required </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> setting up a Kubernetes cluster</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/prepull] This might take a minute or two, depending on the speed of your internet connection</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/prepull] You can also perform this action </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> beforehand using </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;kubeadm config images pull&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/apply] Upgrading your Static Pod-hosted control plane to version </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;v1.28.4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">timeout:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m0s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/etcd] Upgrading to TLS </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> etcd</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Preparing </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;etcd&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> upgrade</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Current and new manifests of etcd are equal, skipping upgrade</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/etcd] Waiting </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> etcd to become available</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Writing new Static Pod manifests to </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;/etc/kubernetes/tmp/kubeadm-upgraded-manifests829415407&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Preparing </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;kube-apiserver&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> upgrade</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Renewing apiserver certificate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Renewing apiserver-kubelet-client certificate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Renewing front-proxy-client certificate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Renewing apiserver-etcd-client certificate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Moved new manifest to </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;/etc/kubernetes/manifests/kube-apiserver.yaml&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> and backed up old manifest to </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;/etc/kubernetes/tmp/kubeadm-backup-manifests-2023-12-01-12-30-22/kube-apiserver.yaml&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Waiting </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> the kubelet to restart the component</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">timeout</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m0s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[apiclient] Found 1 Pods </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> label selector component=kube-apiserver</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Component </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;kube-apiserver&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> upgraded successfully</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">!</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Preparing </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;kube-controller-manager&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> upgrade</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Renewing controller-manager.conf certificate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Moved new manifest to </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;/etc/kubernetes/manifests/kube-controller-manager.yaml&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> and backed up old manifest to </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;/etc/kubernetes/tmp/kubeadm-backup-manifests-2023-12-01-12-30-22/kube-controller-manager.yaml&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Waiting </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> the kubelet to restart the component</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">timeout</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m0s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[apiclient] Found 1 Pods </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> label selector component=kube-controller-manager</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Component </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;kube-controller-manager&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> upgraded successfully</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">!</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Preparing </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;kube-scheduler&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> upgrade</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Renewing scheduler.conf certificate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Moved new manifest to </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;/etc/kubernetes/manifests/kube-scheduler.yaml&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> and backed up old manifest to </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;/etc/kubernetes/tmp/kubeadm-backup-manifests-2023-12-01-12-30-22/kube-scheduler.yaml&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Waiting </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> the kubelet to restart the component</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">timeout</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m0s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[apiclient] Found 1 Pods </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> label selector component=kube-scheduler</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/staticpods] Component </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;kube-scheduler&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> upgraded successfully</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">!</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upload-config] Storing the configuration used </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ConfigMap </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;kubeadm-config&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> the </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;kube-system&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> Namespace</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[kubelet] Creating a ConfigMap </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;kubelet-config&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> namespace kube-system with the configuration </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> the kubelets</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> the cluster</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade] Backing up kubelet config file to /etc/kubernetes/tmp/kubeadm-kubelet-config2580934401/config.yaml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[kubelet-start] Writing kubelet configuration to file </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> order </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> nodes to get long term certificate credentials</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[bootstrap-token] Configured RBAC rules to allow certificate rotation </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> all node client certificates</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> the cluster</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[addons] Applied essential addon: CoreDNS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">W1201</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 12</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:32:07.596874    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">5109</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> postupgrade.go:181] the ConfigMap &quot;kube-proxy&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> in the namespace &quot;kube-system&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> was not found. Assuming that kube-proxy was not deployed for this cluster. Note that once &#39;kubeadm upgrade apply&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> supports phases you will have to skip the kube-proxy upgrade manually</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/successful] SUCCESS</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> Your</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cluster was upgraded to &quot;v1.28.4&quot;. Enjoy!</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> you</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> haven&#39;t already done so.</span></span></code></pre></div><h3 id="升级安装的-cni-cilium" tabindex="-1">升级安装的 CNI：Cilium <a class="header-anchor" href="#升级安装的-cni-cilium" aria-label="Permalink to &quot;升级安装的 CNI：Cilium&quot;">​</a></h3><p>我安装的是 <code>1.14.2</code>，所以应该可以直接升级到 <code>1.14.4</code>，先执行 <code>cilium-preflight</code> 的 Helm Chart 安装来对集群进行预检：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> helm install cilium-preflight cilium/cilium </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	--version</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1.14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.4 </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	--namespace=kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	--set</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> preflight.enabled=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	--set</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> agent=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	--set</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> operator.enabled=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">false</span></span></code></pre></div><p>然后等待 Pod 状态正常</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> watch kubectl get pods -n kube-system</span></span></code></pre></div><p>就像这样</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl get pods -n kube-system</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                                       READY   STATUS    RESTARTS       AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-762f6</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                               1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">93m</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-8fv96</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                               1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">97m</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-operator-657845c48c-lplcg</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">           1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">13m</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-pg92v</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                               1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">92m</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-pre-flight-check-6cb5b47c6d-cd8dw</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-pre-flight-check-fpp7f</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-pre-flight-check-r5vts</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-pre-flight-check-vn9mf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">coredns-5dd5756b68-k9qcl</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                   1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">92m</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">coredns-5dd5756b68-rbjnm</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                   1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">92m</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">etcd-node1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                                 1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">24</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">97m</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">hubble-relay-68b65978cb-82dsf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">93m</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">hubble-ui-6cc5887659-ngf8z</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                 2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/2     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">92m</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-apiserver-node1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                       1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              33</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-controller-manager-node1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">13m</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-scheduler-node1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                       1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">13m</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span></span></code></pre></div><p>等待 <code>cilium-pre-flight-check</code> Deployment 状态正常</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> watch kubectl get deployment -n kube-system cilium-pre-flight-check</span></span></code></pre></div><p>就像这样</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl get deployment -n kube-system cilium-pre-flight-check</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                      READY   UP-TO-DATE   AVAILABLE   AGE</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-pre-flight-check</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">            1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">           14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span></span></code></pre></div><p>预检完成之后就可以删掉了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> helm delete cilium-preflight --namespace=kube-system</span></span></code></pre></div>`,22),C=n(`<div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light one-dark-pro has-diff vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kubernetes</span></span>
<span class="line diff add"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">upgradeCompatibility</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;1.14&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">enableIPv4Masquerade</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">enableIPv6Masquerade</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">hubble</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  relay</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  ui</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">ipam</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  mode</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kubernetes</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    clusterPoolIPv4PodCIDRList</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">10.244.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">ipv4NativeRoutingCIDR</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">10.244.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">k8sServiceHost</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.24.0.2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">k8sServicePort</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">6443</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">kubeProxyReplacement</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">strict</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  replicas</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">serviceAccounts</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  cilium</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-operator</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">tunnel</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">vxlan</span></span></code></pre></div><p>然后执行更新</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> helm upgrade cilium cilium/cilium </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	--version</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1.14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.4 </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	--namespace=kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	-f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-values-initial.yaml</span></span></code></pre></div><p>然后等待资源准备完成：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> watch kubectl get pods -n kube-system</span></span></code></pre></div><p>完成之后再次执行 <code>cilium status</code> 查看状态</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo cilium status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    /¯¯\\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">_/¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Cilium:             OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Operator:           OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> /¯¯\\__/¯¯\\</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Envoy DaemonSet:    disabled </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> embedded mode</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Hubble Relay:       OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    \\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       ClusterMesh:        disabled</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             cilium-operator    Desired: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, Ready: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1, Available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             hubble-ui          Desired: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, Ready: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1, Available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             hubble-relay       Desired: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, Ready: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1, Available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">DaemonSet</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">              cilium             Desired: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, Ready: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/3, Available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Containers:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            cilium             Running: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Running: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-ui</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          Running: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-relay</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       Running: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Pods:          </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">8</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/8 managed by Cilium</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Helm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> chart version:    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Image</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> versions         hubble-relay       quay.io/cilium/hubble-relay:v1.14.4@sha256:ca81622fd9f04c1316bf4144bde5dbce613758810f6022f6c706b14c9c0815db: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             quay.io/cilium/cilium:v1.14.4@sha256:4981767b787c69126e190e33aee93d5a076639083c21f0e7c29596a519c64a2e: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    quay.io/cilium/operator-generic:v1.14.4@sha256:f0f05e4ba3bb1fe0e4b91144fa4fea637701aba02e6c00b23bd03b4a7e1dfd55: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-ui</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          quay.io/cilium/hubble-ui:v0.12.1@sha256:9e5f81ee747866480ea1ac4630eb6975ff9227f9782b7c93919c081c33f38267: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-ui</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          quay.io/cilium/hubble-ui-backend:v0.12.1@sha256:1f86f3400827a0451e6332262467f894eeb7caf0eb8779bd951e2caa9d027cbe: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span></code></pre></div><h2 id="升级其他控制平面节点的-kubeadm" tabindex="-1">升级其他控制平面节点的 <code>kubeadm</code> <a class="header-anchor" href="#升级其他控制平面节点的-kubeadm" aria-label="Permalink to &quot;升级其他控制平面节点的 \`kubeadm\`&quot;">​</a></h2><p>和之前升级第一个控制平面节点不同的是，我们需要用下面的命令来升级其他剩下的<strong>控制平面</strong>节点：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm upgrade node</span></span></code></pre></div><h2 id="逐步升级所有控制平面的节点的-kubelet-和-kubectl" tabindex="-1">逐步升级所有控制平面的节点的 <code>kubelet</code> 和 <code>kubectl</code> <a class="header-anchor" href="#逐步升级所有控制平面的节点的-kubelet-和-kubectl" aria-label="Permalink to &quot;逐步升级所有控制平面的节点的 \`kubelet\` 和 \`kubectl\`&quot;">​</a></h2><h3 id="驱逐-pod" tabindex="-1">驱逐 Pod <a class="header-anchor" href="#驱逐-pod" aria-label="Permalink to &quot;驱逐 Pod&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl drain </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">node-to-drai</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --ignore-daemonsets</span></span></code></pre></div><p>对于我而言的话，按步骤执行</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl drain node1 --ignore-daemonsets</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl drain node2 --ignore-daemonsets</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl drain node3 --ignore-daemonsets</span></span></code></pre></div><p>就好了。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl drain node1 --ignore-daemonsets</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">node/node2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cordoned</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">error:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> unable to drain node &quot;node2&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> due to error:cannot delete Pods with local storage </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">use</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --delete-emptydir-data</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to override</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: kube-system/hubble-ui-6f48889749-zhgx9, continuing command...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">There</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are pending nodes to be drained:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> node2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cannot</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> delete Pods with local storage </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">use</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --delete-emptydir-data</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to override</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: kube-system/hubble-ui-6f48889749-zhgx9</span></span></code></pre></div><p>如果执行的时候遇到上面这样的问题，可以通过</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl drain node2 --ignore-daemonsets --delete-emptydir-data</span></span></code></pre></div><p>来尝试解决。</p>`,20),u=n(`<h3 id="取消驱逐" tabindex="-1">取消驱逐 <a class="header-anchor" href="#取消驱逐" aria-label="Permalink to &quot;取消驱逐&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl uncordon node1</span></span></code></pre></div><p>检查节点状态，看看版本是否对齐：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl get nodes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    STATUS   ROLES           AGE   VERSION</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">node1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Ready    control-plane   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d   v1.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">node2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Ready    </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">          50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d   v1.28.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">node3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Ready    </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">          50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d   v1.28.2</span></span></code></pre></div><p>状态为 <code>Ready</code> 就表示完成了。</p><h2 id="升级负载节点" tabindex="-1">升级负载节点 <a class="header-anchor" href="#升级负载节点" aria-label="Permalink to &quot;升级负载节点&quot;">​</a></h2><h3 id="升级-kubeadm" tabindex="-1">升级 <code>kubeadm</code> <a class="header-anchor" href="#升级-kubeadm" aria-label="Permalink to &quot;升级 \`kubeadm\`&quot;">​</a></h3>`,7),A=n('<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm upgrade node</span></span></code></pre></div><h3 id="驱逐-pod-1" tabindex="-1">驱逐 Pod <a class="header-anchor" href="#驱逐-pod-1" aria-label="Permalink to &quot;驱逐 Pod&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl drain node2 --ignore-daemonsets</span></span></code></pre></div><h3 id="升级-kubelet-和-kubectl" tabindex="-1">升级 <code>kubelet</code> 和 <code>kubectl</code> <a class="header-anchor" href="#升级-kubelet-和-kubectl" aria-label="Permalink to &quot;升级 `kubelet` 和 `kubectl`&quot;">​</a></h3>',4),B=n(`<h3 id="取消驱逐-1" tabindex="-1">取消驱逐 <a class="header-anchor" href="#取消驱逐-1" aria-label="Permalink to &quot;取消驱逐&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>sudo kubectl uncordon node2</span></span></code></pre></div><p>检查节点状态，看看版本是否对齐：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl get nodes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    STATUS   ROLES           AGE   VERSION</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">node1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Ready    control-plane   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d   v1.28.4</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">node2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Ready    </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">          50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d   v1.28.4</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">node3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Ready    </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">          50</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d   v1.28.4</span></span></code></pre></div><p>状态为 <code>Ready</code> 就表示完成了。</p><h2 id="贡献者" tabindex="-1">贡献者 <a class="header-anchor" href="#贡献者" aria-label="Permalink to &quot;贡献者&quot;">​</a></h2>`,6),b=i("h2",{id:"文件历史",tabindex:"-1"},[s("文件历史 "),i("a",{class:"header-anchor",href:"#文件历史","aria-label":'Permalink to "文件历史"'},"​")],-1);function m(E,_,v,D,f,q){const t=h("NolebasePageProperties"),e=h("VPNolebaseInlineLinkPreview"),p=h("NolebaseGitContributors"),k=h("NolebaseGitChangelog");return g(),r("div",null,[c,a(t),y,i("p",null,[s("请先参考"),a(e,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/Kubernetes 集群的日常升级和更新/通过 apt 升级和更新 1.28.4 版本的 kubeadm.html"},{default:l(()=>[s("通过 apt 升级和更新 1.28.4 版本的 kubeadm")]),_:1}),s(" 完成这部分的步骤。")]),F,i("p",null,[s("编辑我们之前在通过 "),a(e,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/在 Kubeadm 部署的 Kubernetes 集群中安装 Cilium.html"},{default:l(()=>[s("Helm 安装 Cilium")]),_:1}),s(" 的时候用的 values，并且添加一行：")]),C,i("p",null,[s("请先参考"),a(e,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/Kubernetes 集群的日常升级和更新/通过 apt 升级和更新 1.28.4 版本的 kubelet 和 kubectl.html"},{default:l(()=>[s("通过 apt 升级和更新 1.28.4 版本的 kubelet 和 kubectl")]),_:1}),s(" 完成这部分的步骤。")]),u,i("p",null,[s("请先参考"),a(e,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/Kubernetes 集群的日常升级和更新/通过 apt 升级和更新 1.28.4 版本的 kubeadm.html"},{default:l(()=>[s("通过 apt 升级和更新 1.28.4 版本的 kubeadm")]),_:1}),s(" 完成这部分的步骤。")]),A,i("p",null,[s("请先参考"),a(e,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/Kubernetes 集群的日常升级和更新/通过 apt 升级和更新 1.28.4 版本的 kubelet 和 kubectl.html"},{default:l(()=>[s("通过 apt 升级和更新 1.28.4 版本的 kubelet 和 kubectl")]),_:1}),s(" 完成这部分的步骤。")]),B,a(p),b,a(k)])}const T=d(o,[["render",m]]);export{P as __pageData,T as default};
