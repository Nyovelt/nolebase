import{_ as r,c as d,J as a,m as s,w as l,a as i,V as h,E as k,o as g}from"./chunks/framework.WH0rnJL5.js";const is=JSON.parse('{"title":"”灾难性“地将 Homelab K8s 的 Calico 迁移到 Cilium","description":"","frontmatter":{"tags":["开发/云原生","计算机/计算机科学/CS/虚拟化","开发/云原生/Kubernetes","开发/容器化","开发/虚拟化","开发/容器化/Docker","开发/云原生/Docker","命令行/kubectl","命令行/kubeadm","命令行/containerd","命令行/docker","软件/云原生/kubeadm","软件/云原生/kubelet","软件/云原生/kubectl","软件/云原生/containerd","软件/云原生/docker","开发/虚拟化/cgroup","运维/云原生/Kubernetes/K8s","开发/云原生/Kubernetes/K8s","运维/云原生/Kubernetes","计算机/网络","运维/Cilium","命令行/cilium","软件/云原生/Cilium","软件/云原生/kube-proxy","计算机/网络/Calico","运维/Calico","软件/云原生/Calico","计算机/网络/Cilium","开发/标记语言/YAML"]},"headers":[],"relativePath":"笔记/🧱 基础设施/🚢 Kubernetes/”灾难性“地将 Homelab K8s 的 Calico 迁移到 Cilium.md","filePath":"笔记/🧱 基础设施/🚢 Kubernetes/”灾难性“地将 Homelab K8s 的 Calico 迁移到 Cilium.md"}'),F={name:"笔记/🧱 基础设施/🚢 Kubernetes/”灾难性“地将 Homelab K8s 的 Calico 迁移到 Cilium.md"},C=s("h1",{id:"灾难性-地将-homelab-k8s-的-calico-迁移到-cilium",tabindex:"-1"},[i("”灾难性“地将 Homelab K8s 的 Calico 迁移到 Cilium "),s("a",{class:"header-anchor",href:"#灾难性-地将-homelab-k8s-的-calico-迁移到-cilium","aria-label":'Permalink to "”灾难性“地将 Homelab K8s 的 Calico 迁移到 Cilium"'},"​")],-1),y=s("h3",{id:"文档兼容性",tabindex:"-1"},[i("文档兼容性 "),s("a",{class:"header-anchor",href:"#文档兼容性","aria-label":'Permalink to "文档兼容性"'},"​")],-1),o=s("thead",null,[s("tr",null,[s("th",null,"主体"),s("th",null,"版本号"),s("th",null,"文档地址（如果有）")])],-1),c=s("tr",null,[s("td",null,"Debian"),s("td",null,"11"),s("td")],-1),u=s("td",null,"Kubernetes",-1),A=s("td",null,"1.28",-1),E=s("td",null,"Docker",-1),m=s("td",null,"24.0.2",-1),b=s("tr",null,[s("td",null,"containerd"),s("td",null,"1.7.6"),s("td")],-1),B=s("tr",null,[s("td",null,"Linux kernel"),s("td",null,"5.10.0"),s("td")],-1),D=s("tr",null,[s("td",null,"Calico"),s("td"),s("td")],-1),v=s("td",null,"Cilium",-1),f=s("td",null,"1.14.2",-1),_=s("td",null,"helm",-1),q=s("td",null,"v3.9.0",-1),P=s("h2",{id:"简单删除-calico-之后安装-cilium",tabindex:"-1"},[i("简单删除 Calico 之后安装 Cilium "),s("a",{class:"header-anchor",href:"#简单删除-calico-之后安装-cilium","aria-label":'Permalink to "简单删除 Calico 之后安装 Cilium"'},"​")],-1),I=s("h3",{id:"安装-cilium",tabindex:"-1"},[i("安装 Cilium "),s("a",{class:"header-anchor",href:"#安装-cilium","aria-label":'Permalink to "安装 Cilium"'},"​")],-1),x=h(`<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium install --version </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2</span></span></code></pre></div><p>来安装 Cilium。</p><p>等待一段时间之后发现我们的 KubeSphere 面板不再响应了，而是返回了 502 错误，这个时候我们检查一下 KubeSphere 的 API 服务器：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl describe pods -n kubesphere-system ks-apiserver-6cd95fb98f-kvdkb</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Events:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Type</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     Reason                  Age                From     Message</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     ------</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                  ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">               ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     -------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Warning</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Unhealthy               </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">22</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">x8</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> over </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">23</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)  </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kubelet  Liveness probe failed: Get &quot;http://10.233.90.228:9090/kapis/version&quot;: dial tcp </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.233</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.90.228:9090: connect: invalid argument</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Normal</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Killing                 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">22</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m                kubelet  Container ks-apiserver failed liveness probe, will be restarted</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Normal</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Pulled                  </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">22</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m                kubelet  Container image &quot;kubesphere/ks-apiserver:v3.3.1&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> already present on machine</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Normal</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Created                 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">22</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m                kubelet  Created container ks-apiserver</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Normal</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Started                 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">22</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m                kubelet  Started container ks-apiserver</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Warning</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  FailedCreatePodSandBox  </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m                kubelet  Failed to create pod sandbox: rpc error: code = Unknown desc = failed to set up sandbox container &quot;ed593ddb9cd630d2fc136e83c31d464cb97fa70712b2f4f85f0f5f73b38f055b&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> network for pod &quot;ks-apiserver-6cd95fb98f-kvdkb&quot;: networkPlugin cni failed to set up pod &quot;ks-apiserver-6cd95fb98f-kvdkb_kubesphere-system&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> network: unable to connect to Cilium daemon: failed to create cilium agent client after </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">30.000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> seconds timeout: Get &quot;http://localhost/v1/config&quot;: dial unix /var/run/cilium/cilium.sock: connect: no such file or directory</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Is</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the agent running?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Warning</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  FailedCreatePodSandBox  </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">18</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m  kubelet  Failed to create pod sandbox: rpc error: code = Unknown desc = failed to set up sandbox container &quot;5001e5aa69fecab537abe27c5900d84a6049f50883695d04a9c9f1ed734a1b20&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> network for pod &quot;ks-apiserver-6cd95fb98f-kvdkb&quot;: networkPlugin cni failed to set up pod &quot;ks-apiserver-6cd95fb98f-kvdkb_kubesphere-system&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> network: unable to connect to Cilium daemon: failed to create cilium agent client after </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">30.000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> seconds timeout: Get &quot;http://localhost/v1/config&quot;: dial unix /var/run/cilium/cilium.sock: connect: no such file or directory</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Is</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the agent running?</span></span></code></pre></div><p>可以发现 Cilium 其实没有正常运行起来，让我们看看 <code>kubelet</code> 怎么样：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo systemctl status kubelet</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">●</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubelet.service - kubelet: The Kubernetes Node Agent</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Loaded:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> loaded </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/etc/systemd/system/kubelet.service</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">vendor</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> preset: enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Drop-In:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /etc/systemd/system/kubelet.service.d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             └─10-kubeadm.conf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Active:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> active </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">running</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">since Sat </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2023</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">-09-30 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:10:16 CST</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">34min</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       Docs:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> http://kubernetes.io/docs/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   Main</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> PID: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubelet</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      Tasks:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 175</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">limit:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 9830</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Memory:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 325.8</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">M</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">        CPU:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">min </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">55.659</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     CGroup:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /system.slice/kubelet.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /usr/local/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --cgroup-driver=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">s</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─50849</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─50935</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─50971</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─50972</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─51015</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─51283</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─51306</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─51323</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─51337</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─51381</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             ├─51398</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             └─51414</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /opt/cni/bin/cilium-cni</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:17 node1 kubelet[</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">]: E0930 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:17.246138     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cni.go:361] &quot;Error adding pod to network&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> err=&quot;unable to connect to Cilium daemon: failed to create cilium agent client after 30.000000 seconds timeout: Get </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">http://localhost/v1/config</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: dial unix /var/run/cilium/cilium.sock: connect: no such file or directory\\nIs the agent running?&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pod=&quot;kubesphere-monitoring-system/kube-state-metrics-687d66b747-5s6rt&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:17 node1 kubelet[</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">]: E0930 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:17.614511     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubelet_volumes.go:245] &quot;There were many similar errors. Turn up verbosity to see them.&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> err=&quot;orphaned pod </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">1f1a54f9-7023-4995-a4c0-de78&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">9月 30 20:44:17 node1 kubelet[506]: E0930 20:44:17.986337     506 cni.go:361] &quot;Error adding pod to network&quot; err=&quot;unable to connect to Cilium daemon: failed to create cilium agent client after </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">30.000000</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> s</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:18 node1 kubelet[</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">]: E0930 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:18.428698     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cni.go:361] &quot;Error adding pod to network&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> err=&quot;unable to connect to Cilium daemon: failed to create cilium agent client after 30.000000 seconds timeout: Get </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">http://localhost/v1/config</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: dial unix /var/run/cilium/cilium.sock: connect: no such file or directory\\nIs the agent running?&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pod=&quot;kubesphere-monitoring-system/kube-state-metrics-687d66b747-5s6rt&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:19 node1 kubelet[</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">]: E0930 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:19.582819     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubelet_volumes.go:245] &quot;There were many similar errors. Turn up verbosity to see them.&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> err=&quot;orphaned pod </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">1f1a54f9-7023-4995-a4c0-de78&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">9月 30 20:44:20 node1 kubelet[506]: E0930 20:44:20.573676     506 remote_runtime.go:116] &quot;RunPodSandbox from runtime service failed&quot; err=&quot;rpc error: code = Unknown desc = failed to set up sandbox contai</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:20 node1 kubelet[</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">]: E0930 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:20.573860     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kuberuntime_sandbox.go:70] &quot;Failed to create sandbox for pod&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> err=&quot;rpc error: code = Unknown desc = failed to set up sandbox container </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">9月 30 20:44:20 node1 kubelet[506]: E0930 20:44:20.573973     506 kuberuntime_manager.go:819] &quot;CreatePodSandbox for pod failed&quot; err=&quot;rpc error: code = Unknown desc = failed to set up sandbox container </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:20 node1 kubelet[</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">]: E0930 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:20.574210     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pod_workers.go:951] &quot;Error syncing pod, skipping&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> err=&quot;failed to </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">CreatePodSandbox</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kube-state-metrics-687d66b747-5s6rt_kubespher&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">9月 30 20:44:21 node1 kubelet[506]: E0930 20:44:21.601638     506 kubelet_volumes.go:245] &quot;There were many similar errors. Turn up verbosity to see them.&quot; err=&quot;orphaned pod </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">1f1a54f9-7023-4995-a4c0-de7</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">8&gt;</span></span></code></pre></div><p>可以发现也是一样的报错：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:18 node1 kubelet[</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">]: E0930 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:44:18.428698     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">506</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cni.go:361] &quot;Error adding pod to network&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> err=&quot;unable to connect to Cilium daemon: failed to create cilium agent client after 30.000000 seconds timeout: Get </span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">http://localhost/v1/config</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: dial unix /var/run/cilium/cilium.sock: connect: no such file or directory\\nIs the agent running?&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pod=&quot;kubesphere-monitoring-system/kube-state-metrics-687d66b747-5s6rt&quot;</span></span></code></pre></div><p>这说明我们的 Cilium 无法运行起来，也许是 Calico 相关的资源没有清理干净。</p><h2 id="移除冲突的-尚未完全清理干净的-calico-相关的资源" tabindex="-1">移除冲突的，尚未完全清理干净的 Calico 相关的资源 <a class="header-anchor" href="#移除冲突的-尚未完全清理干净的-calico-相关的资源" aria-label="Permalink to &quot;移除冲突的，尚未完全清理干净的 Calico 相关的资源&quot;">​</a></h2>`,10),T=h(`<p>然后我们需要重新安装一下 Cilium。</p><h2 id="卸载-cilium" tabindex="-1">卸载 Cilium <a class="header-anchor" href="#卸载-cilium" aria-label="Permalink to &quot;卸载 Cilium&quot;">​</a></h2><p>我们再运行一下 <code>cilium uninstall</code> 试试看，然后删除 Cilium 的 CNI 配置：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rm -rf /etc/cni/net.d/05-cilium.conflist</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rm -rf /etc/cni/net.d/10-calico.conflist.cilium_bak</span></span></code></pre></div><p>移除之后发现容器还是在报错，我们用 <code>kubectl describe</code> 看看配置和事件：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl describe pod redis-v1-fb59985cc-lj4j2 -n bots</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Tolerations:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                 node.kubernetes.io/not-ready:NoExecute op=Exists for </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">300</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                             node.kubernetes.io/unreachable:NoExecute</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> op=Exists for </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">300</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Events:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Type</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     Reason            Age    From               Message</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     ------</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">            ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">               -------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Warning</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  FailedScheduling  </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">45</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m    default-scheduler  </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/3 nodes are available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> node</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">had taint {node.cilium.io/agent-not-ready: }, that the pod didn&#39;t tolerate.</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Warning  FailedScheduling  44m    default-scheduler  0/3 nodes are available: 3 node(s) had taint {node.cilium.io/agent-not-ready: }, that the pod didn&#39;t tolerate.</span></span></code></pre></div><p>可以发现有两个污点和关于 <code>node.cilium.io/agent-not-ready</code> 污点的报错，但是我们已经把 Cilium 移除了，所以这里的污点我们不清楚是哪里配置上来的，我们可以用：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl taint nodes node1 node.cilium.io/agent-not-ready-</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl taint nodes node2 node.cilium.io/agent-not-ready-</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl taint nodes node3 node.cilium.io/agent-not-ready-</span></span></code></pre></div><p>给移除了，移除之后再次重启全部节点的 <code>kubelet</code> 试试看是否还有残余：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> systemctl restart kubelet</span></span></code></pre></div><p>这个时候我们再次观察就能发现只剩下我们预期内的 <code>node.kubernetes.io/not-ready</code>（K8s 节点未准备好）污点了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl describe pods redis-v1-fb59985cc-p2r5r -n bots</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Tolerations:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                 node.kubernetes.io/not-ready:NoExecute op=Exists for </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">300</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                             node.kubernetes.io/unreachable:NoExecute</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> op=Exists for </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">300</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Events:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Type</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     Reason            Age    From               Message</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     ------</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">            ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">               -------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Warning</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  FailedScheduling  </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">46</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m    default-scheduler  </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/3 nodes are available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> node</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">had taint {node.cilium.io/agent-not-ready: }, that the pod didn&#39;t tolerate.</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Warning  FailedScheduling  44m    default-scheduler  0/3 nodes are available: 3 node(s) had taint {node.cilium.io/agent-not-ready: }, that the pod didn&#39;t tolerate.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Warning</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  FailedScheduling  </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m51s  default-scheduler  </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/3 nodes are available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> node</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">had taint {node.kubernetes.io/not-ready: }, that the pod didn&#39;t tolerate.</span></span></code></pre></div><p>这个时候由于我们在之前已经删除了 Calico，也删除了有冲突配置的 Cilium，这个时候预期情况下我们会出现 CNI 插件缺失的报错：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo systemctl status kubelet</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">●</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubelet.service - kubelet: The Kubernetes Node Agent</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Loaded:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> loaded </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/etc/systemd/system/kubelet.service</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">vendor</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> preset: enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Drop-In:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /etc/systemd/system/kubelet.service.d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             └─10-kubeadm.conf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Active:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> active </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">running</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">since Sat </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2023</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">-09-30 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:48:45 CST</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">5min</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       Docs:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> http://kubernetes.io/docs/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   Main</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> PID: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">23191</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubelet</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      Tasks:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 19</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">limit:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 9830</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Memory:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 52.4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">M</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">        CPU:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 47.656</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     CGroup:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /system.slice/kubelet.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             └─23191</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /usr/local/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --cgroup-driver=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">s</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9月</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:53:55 node1 kubelet[</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">23191</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">]: E0930 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:53:55.698482   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">23191</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pod_workers.go:951] &quot;Error syncing pod, skipping&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> err=&quot;network is not ready: container runtime network not ready: NetworkReady=false NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pod=&quot;kubesphere-monitoring-system/kube-state-metrics-687d66b747-5s6rt&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> podUID=ba43f196-a8c9-4d87-a18c-e847cef665d0</span></span></code></pre></div><h2 id="安装-cilium-1" tabindex="-1">安装 Cilium <a class="header-anchor" href="#安装-cilium-1" aria-label="Permalink to &quot;安装 Cilium&quot;">​</a></h2><p>这是正常的，这个时候我们再次执行一下 Cilium 官方文档教的安装：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo cilium install --version </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Using Cilium version </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">🔮</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Auto-detected cluster name: cluster.local</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">🔮</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Auto-detected kube-proxy has been installed</span></span></code></pre></div><p>等待一会儿在执行：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium status --wait</span></span></code></pre></div><p>然后就能看到我们的 cilium 现在状态正常了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo cilium status --wait</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    /¯¯\\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">_/¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Cilium:             OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Operator:           OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> /¯¯\\__/¯¯\\</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Envoy DaemonSet:    disabled </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> embedded mode</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Hubble Relay:       disabled</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    \\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       ClusterMesh:        disabled</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">DaemonSet</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">              cilium             Desired: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, Ready: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/3, Available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             cilium-operator    Desired: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, Ready: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1, Available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Containers:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            cilium-operator    Running: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             Running: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Pods:          </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/55 managed by Cilium</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Helm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> chart version:    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Image</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> versions         cilium             quay.io/cilium/cilium:v1.14.2@sha256:6263f3a3d5d63b267b538298dbeb5ae87da3efacf09a2c620446c873ba807d35: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    quay.io/cilium/operator-generic:v1.14.2@sha256:52f70250dea22e506959439a7c4ea31b10fe8375db62f5c27ab746e3a2af866d: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span></code></pre></div><h2 id="出现网络问题" tabindex="-1">出现网络问题 <a class="header-anchor" href="#出现网络问题" aria-label="Permalink to &quot;出现网络问题&quot;">​</a></h2><h3 id="联通性测试不通过" tabindex="-1">联通性测试不通过 <a class="header-anchor" href="#联通性测试不通过" aria-label="Permalink to &quot;联通性测试不通过&quot;">​</a></h3><p>安装之后我们执行：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium connectivity test</span></span></code></pre></div><p>来进行网络连接测试，会发现 <code>cilium-test/client</code> 部署失败了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo cilium connectivity test</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Monitor aggregation detected, will skip some flow validation steps</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✨</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [cluster.local] Creating namespace cilium-test </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> connectivity check...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✨</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [cluster.local] Deploying echo-same-node service...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✨</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [cluster.local] Deploying DNS test server configmap...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✨</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [cluster.local] Deploying same-node deployment...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✨</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [cluster.local] Deploying client deployment...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✨</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [cluster.local] Deploying client2 deployment...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✨</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [cluster.local] Deploying echo-other-node service...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✨</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [cluster.local] Deploying other-node deployment...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✨</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [host-netns] Deploying cluster.local daemonset...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✨</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [host-netns-non-cilium] Deploying cluster.local daemonset...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✨</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [cluster.local] Deploying echo-external-node deployment...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">⌛</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [cluster.local] Waiting </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> deployment cilium-test/client to become ready...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">connectivity</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test failed: timeout reached waiting for deployment cilium-test/client to become ready </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">last</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> error: only </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> of </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> replicas are available</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span></code></pre></div><p>我们可以观察一下事件：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl -n cilium-test describe deployment client</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Events:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Type</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Reason             Age   From                   Message</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    ------</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">             ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                   -------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Normal</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  ScalingReplicaSet  </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m   deployment-controller  Scaled up replica set client-7dccdf9bdf to </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span></code></pre></div><p>看起来我们的 <code>deployment</code> 失败在扩容到 1 份 Replica，那我们看看 Pod 这边是卡在哪个环节了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl -n cilium-test get pods</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                                  READY   STATUS              RESTARTS   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">client-7dccdf9bdf-tmc5h</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">               0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     ImagePullBackOff    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">          20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">client2-5fd767c97f-bl84c</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     ImagePullBackOff    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">          20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span></code></pre></div><h3 id="镜像拉取失败" tabindex="-1">镜像拉取失败 <a class="header-anchor" href="#镜像拉取失败" aria-label="Permalink to &quot;镜像拉取失败&quot;">​</a></h3><p>看起来是 <code>ImagePullBackoff</code> 了，无法拉取镜像，我们看看具体的事件吧：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl describe pods -n cilium-test client-7dccdf9bdf-tmc5h</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Events:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Type</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     Reason     Age                  From               Message</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     ------</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                 ----</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">               -------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Normal</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Scheduled  </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m                  default-scheduler  Successfully assigned cilium-test/client-7dccdf9bdf-tmc5h to node1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Warning</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Failed     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">6</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m41s                kubelet            Failed to pull image &quot;quay.io/cilium/alpine-curl:v1.7.0@sha256:ccd0ed9da1752bab88a807647ad3cec65d460d281ab88988b60d70148783e751&quot;: rpc error: code = Unknown desc = Error response from daemon: Get &quot;https://quay.io/v2/&quot;: net/http: request canceled while waiting for connection </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Client.Timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exceeded while awaiting headers</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Warning</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Failed     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">6</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m41s                kubelet            Error: ErrImagePull</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Normal</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   BackOff    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">6</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m40s                kubelet            Back-off pulling image &quot;quay.io/cilium/alpine-curl:v1.7.0@sha256:ccd0ed9da1752bab88a807647ad3cec65d460d281ab88988b60d70148783e751&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Warning</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Failed     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">6</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m40s                kubelet            Error: ImagePullBackOff</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Normal</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Pulling    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">6</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m27s </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">x2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> over </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">19</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)  </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kubelet            Pulling image &quot;quay.io/cilium/alpine-curl:v1.7.0@sha256:ccd0ed9da1752bab88a807647ad3cec65d460d281ab88988b60d70148783e751&quot;</span></span></code></pre></div><p>看起来也许是 Homelab 这边网络有点爆炸。在调整了 Clash 节点选择之后依然不行，我们得深入调查一下。</p><h3 id="排查-coredns-和相关的-pod" tabindex="-1">排查 coredns 和相关的 Pod <a class="header-anchor" href="#排查-coredns-和相关的-pod" aria-label="Permalink to &quot;排查 coredns 和相关的 Pod&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl get pods -n kube-system</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                                           READY   STATUS             RESTARTS       AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-mdtzl</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                                   1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              8</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-mmh9j</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                                   1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              8</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-operator-8bf9464bf-xdb7l</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">8h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">8</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cilium-rqhvs</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                                   1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              8</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">coredns-b5648d655-d8ltm</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                        0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     ImagePullBackOff   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              11</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">coredns-b5648d655-p5j5d</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                        0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     ImagePullBackOff   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              8</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">hubble-relay-85cff75759-hlpk4</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                  0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     ErrImagePull       </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              7</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">h19m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">hubble-ui-78b9fbc9cb-hqmw6</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                     0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/2     ErrImagePull       </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">              7</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">h19m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-apiserver-node1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                           1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">19</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">308</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-controller-manager-node1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                  1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">8h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">308</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-proxy-bjrg4</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                               1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">19</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">308</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-proxy-h6cqw</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                               1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">17</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">308</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-proxy-s9pbw</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                               1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">308</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kube-scheduler-node1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                           1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">28</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">8h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">308</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">nodelocaldns-56lvx</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                             1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">308</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">nodelocaldns-h5hf4</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                             1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">17</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">308</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">nodelocaldns-rk2fh</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                             1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">19</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">9h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">308</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openebs-localpv-provisioner-57bbf864d5-2hkzr</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     ErrImagePull       </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">15</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">308</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">snapshot-controller-0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">                          1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1     Running            </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">15</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10h</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)   </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">308</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">d</span></span></code></pre></div><p>看起来 <code>coredns</code> 自己就起不来了。深入查看一下 <code>coredns</code> 这个 Pod 的 <code>ImagePullBackOff</code> 的原因：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>$ sudo kubectl describe pods coredns-b5648d655-d8ltm -n kube-system</span></span>
<span class="line"><span></span></span>
<span class="line"><span>...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Tolerations:                 CriticalAddonsOnly op=Exists</span></span>
<span class="line"><span>                             node-role.kubernetes.io/control-plane:NoSchedule</span></span>
<span class="line"><span>                             node-role.kubernetes.io/master:NoSchedule</span></span>
<span class="line"><span>                             node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span></span>
<span class="line"><span>                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span></span>
<span class="line"><span>Events:</span></span>
<span class="line"><span>  Type     Reason   Age                    From     Message</span></span>
<span class="line"><span>  ----     ------   ----                   ----     -------</span></span>
<span class="line"><span>  Warning  Failed   18m (x77 over 8h)      kubelet  Failed to pull image &quot;coredns/coredns:1.8.0&quot;: rpc error: code = Unknown desc = Error response from daemon: Get &quot;https://registry-1.docker.io/v2/&quot;: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</span></span>
<span class="line"><span>  Normal   Pulling  13m (x86 over 8h)      kubelet  Pulling image &quot;coredns/coredns:1.8.0&quot;</span></span>
<span class="line"><span>  Normal   BackOff  3m28s (x1857 over 8h)  kubelet  Back-off pulling image &quot;coredns/coredns:1.8.0&quot;</span></span></code></pre></div><h3 id="定位到网络问题" tabindex="-1">定位到网络问题 <a class="header-anchor" href="#定位到网络问题" aria-label="Permalink to &quot;定位到网络问题&quot;">​</a></h3><p>看起来不光是 <code>quay.io</code> 的镜像服务无法访问到，<code>docker.io</code> 也不行。我们可以用 <code>curl</code> 直接试试看：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> curl https://registry-1.docker.io/v2/ -I</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">curl:</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (6) Could not resolve host: registry-1.docker.io</span></span></code></pre></div><p>发现无法解析了，那我们看看本机的 DNS 呢：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dig registry-1.docker.io @8.8.8.8</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; &lt;&lt;&gt;&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">DiG</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 9.16</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.37-Debian </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;&lt;&gt;&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">registry-1.docker.io @8.8.8.8</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">global</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> options: +cmd</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Got</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> answer:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">-&gt;&gt;HEADER&lt;&lt;-</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> opcode: QUERY, status: NOERROR, id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">19821</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">flags:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> qr aa rd ra</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">QUERY:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, ANSWER: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, AUTHORITY: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, ADDITIONAL: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">QUESTION</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SECTION:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">registry-1.docker.io.</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">		IN	A</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ANSWER</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SECTION:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">registry-1.docker.io.</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">	IN	A	</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">18.215</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.138.58</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">registry-1.docker.io.</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">	IN	A	</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">52.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.184.176</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">registry-1.docker.io.</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">	IN	A	</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">34.194</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.164.123</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Query</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msec</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">SERVER:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 8.8</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.8.8#53</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">8.8.8.8</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">WHEN:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Sun Oct </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">01</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 09</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:13:02 CST </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2023</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">MSG</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SIZE  rcvd: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">86</span></span></code></pre></div><p>正常，但是 <code>10.0.0.1</code> 的 Homelab Gateway 路由器的 DNS 连接不上了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dig registry-1.docker.io @10.0.0.1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; &lt;&lt;&gt;&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">DiG</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 9.16</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.37-Debian </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;&lt;&gt;&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">registry-1.docker.io @10.0.0.1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">global</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> options: +cmd</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">connection</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> timed out</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">no</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> servers could be reached</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ping </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.1 </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.0.0.1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">56</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.1: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">63</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.695</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.1: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">63</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.777</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.1: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">63</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.536</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.1: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">63</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.754</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">^C</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.1 ping statistics ---</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> packets transmitted, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> received, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">% packet loss, time </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">5998</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">rtt</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> min/avg/max/mdev = </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.536</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/0.685/0.777/0.078 ms</span></span></code></pre></div><p>能 ping 通，但是如果用 mtr 看的话能发现 10.0.0.1 的 hostname 不是我们的 Gateway 路由器会正常返回的 hostname：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">node1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.0.2.208) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 10.0.0.1                                                                                                                                                     2023-10-01T09:18:40+0800</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Keys:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Help   Display mode   Restart statistics   Order of fields   quit</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                                                                                                                                                                   Packets</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">               Pings</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> Host</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                                                                                                                                                            Loss%   Snt   Last   Avg  Best  Wrst StDev</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> 1.</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (waiting </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">for reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> 2.</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.1                                                                                                                                                      </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">%     </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    0.8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   0.8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   0.7</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   0.9</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   0.0</span></span></code></pre></div><p>应该是路由到了别的地方去了，可以再检查一下路由表：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ip route</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">default</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> via </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.1 dev eth0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.0.0.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> via </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2.208 dev cilium_host proto kernel src </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2.208 mtu </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1450</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.0.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev eth0 proto kernel scope link src </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.124</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.0.1.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> via </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2.208 dev cilium_host proto kernel src </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2.208 mtu </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1450</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.0.2.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> via </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2.208 dev cilium_host proto kernel src </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2.208</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.0.2.208</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev cilium_host proto kernel scope link</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.24.0.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev eth1 proto kernel scope link src </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">172.17.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev docker0 proto kernel scope link src </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">172.17</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.1 linkdown</span></span></code></pre></div><p>确实是这样。</p>`,52),S=h(`<blockquote><p><code>10.0.0.0/8</code> 是默认的 Pod CIDR。如果您的节点网络位于同一范围内，您将失去与其他节点的连接。假定所有出口流量都针对给定节点上的 Pod，而不是其他节点。</p><p>您可以通过两种方式解决：</p><ul><li>显式将 <code>clusterPoolIPv4PodCIDRList</code> 设置为不冲突的 CIDR</li><li>为您的节点使用不同的 CIDR</li></ul></blockquote><p>OK，那我们检查一下是不是真的是这样：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl get ciliumnodes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    CILIUMINTERNALIP   INTERNALIP   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">node1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2.208         </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.2    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">node2</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.1.157         </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.4    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">node3</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.78          </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.5    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">h</span></span></code></pre></div><p>不太对劲，我们 describe 看看：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo kubectl describe ciliumnodes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">         node1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Namespace:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Labels:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       beta.kubernetes.io/arch=amd64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              beta.kubernetes.io/os</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=linux</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              kubernetes.io/arch</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=amd64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              kubernetes.io/hostname</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=node1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              kubernetes.io/os</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=linux</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">              node-access</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ssh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              node-role.kubernetes.io/control-plane</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              node-role.kubernetes.io/master</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              node-role.kubernetes.io/worker</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              node.kubernetes.io/exclude-from-external-load-balancers</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Annotations:</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">API</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Version:  cilium.io/v2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Kind:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">         CiliumNode</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Spec:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Addresses:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Ip:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    10.24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  InternalIP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Ip:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2.208</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  CiliumInternalIP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Alibaba</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> - Cloud:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Azure:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Encryption:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Eni:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Health:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    ipv4:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2.140</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Ingress:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Ipam:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Pod</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> CID Rs:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      10.0.2.0/24</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Pools:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Status:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Alibaba</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> - Cloud:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Azure:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Eni:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Ipam:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Operator</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> - Status:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Events:</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">         node2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Namespace:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Labels:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       beta.kubernetes.io/arch=amd64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              beta.kubernetes.io/os</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=linux</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              kubernetes.io/arch</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=amd64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              kubernetes.io/hostname</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=node2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              kubernetes.io/os</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=linux</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">              node-access</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ssh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              node-role.kubernetes.io/worker</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Annotations:</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">API</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Version:  cilium.io/v2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Kind:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">         CiliumNode</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Spec:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Addresses:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Ip:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    10.24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  InternalIP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Ip:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.1.157</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  CiliumInternalIP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Alibaba</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> - Cloud:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Azure:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Encryption:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Eni:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Health:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    ipv4:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.1.242</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Ingress:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Ipam:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Pod</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> CID Rs:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      10.0.1.0/24</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Pools:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Status:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Alibaba</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> - Cloud:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Azure:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Eni:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Ipam:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Operator</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> - Status:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Events:</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">         node3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Namespace:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Labels:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       beta.kubernetes.io/arch=amd64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              beta.kubernetes.io/os</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=linux</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              kubernetes.io/arch</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=amd64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              kubernetes.io/hostname</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=node3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              kubernetes.io/os</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=linux</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">              node-access</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ssh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">              node-role.kubernetes.io/worker</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Annotations:</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">API</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Version:  cilium.io/v2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Kind:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">         CiliumNode</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Spec:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Addresses:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Ip:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    10.24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  InternalIP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Ip:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.78</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  CiliumInternalIP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Alibaba</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> - Cloud:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Azure:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Encryption:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Eni:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Health:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    ipv4:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.87</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Ingress:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Ipam:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Pod</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> CID Rs:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      10.0.0.0/24</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Pools:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Status:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Alibaba</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> - Cloud:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Azure:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Eni:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Ipam:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Operator</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> - Status:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Events:</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre></div>`,7),R=s("h2",{id:"为修复-cidr-冲突重装-cilium",tabindex:"-1"},[i("为修复 CIDR 冲突重装 Cilium "),s("a",{class:"header-anchor",href:"#为修复-cidr-冲突重装-cilium","aria-label":'Permalink to "为修复 CIDR 冲突重装 Cilium"'},"​")],-1),w=s("h4",{id:"卸载-cilium-1",tabindex:"-1"},[i("卸载 Cilium "),s("a",{class:"header-anchor",href:"#卸载-cilium-1","aria-label":'Permalink to "卸载 Cilium"'},"​")],-1),N=h(`<h4 id="检查网络是否恢复" tabindex="-1">检查网络是否恢复 <a class="header-anchor" href="#检查网络是否恢复" aria-label="Permalink to &quot;检查网络是否恢复&quot;">​</a></h4><p>清理之后我们再次检查网络联通性：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ping baidu.com</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> baidu.com </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">110.242.68.66</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">56</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">110.242</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.68.66 </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">110.242.68.66</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.564</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">110.242</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.68.66 </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">110.242.68.66</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.569</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">110.242</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.68.66 </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">110.242.68.66</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.514</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">110.242</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.68.66 </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">110.242.68.66</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.874</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">^C</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> baidu.com ping statistics ---</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> packets transmitted, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> received, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">% packet loss, time </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2998</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">rtt</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> min/avg/max/mdev = </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.514</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/0.630/0.874/0.142 ms</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> curl baidu.com -L -I</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">HTTP/1.1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 200</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Date:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Fri, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">06</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Oct </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2023</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 03</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:43:26 GMT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Server:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Apache</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Last-Modified:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Tue, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">12</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Jan </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2010</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:48:00 GMT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ETag:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;51-47cf7e6ee8400&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Accept-Ranges:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Content-Length:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 81</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Cache-Control:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> max-age=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">86400</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Expires:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Sat, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">07</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Oct </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2023</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 03</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:43:26 GMT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Connection:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Keep-Alive</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Content-Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> text/html</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ping google.com</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">PING</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> google.com </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">142.250.204.46</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">56</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">84</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from hkg07s38-in-f14.1e100.net </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">142.250.204.46</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.660</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from hkg07s38-in-f14.1e100.net </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">142.250.204.46</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.570</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from hkg07s38-in-f14.1e100.net </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">142.250.204.46</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.611</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> bytes from hkg07s38-in-f14.1e100.net </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">142.250.204.46</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">: icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.609</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">^C</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> google.com ping statistics ---</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> packets transmitted, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> received, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">% packet loss, time </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3002</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">rtt</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> min/avg/max/mdev = </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0.570</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/0.612/0.660/0.031 ms</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> curl google.com -L -I</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">HTTP/1.1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 301</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Moved Permanently</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Location:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> http://www.google.com/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Content-Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> text/html</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">charset</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">UTF-8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Content-Security-Policy-Report-Only:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> object-src &#39;none&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">base-uri</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;self&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">script-src</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;nonce-TZgO-fIhEQR2thcKEH04rw&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;strict-dynamic&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;report-sample&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;unsafe-eval&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;unsafe-inline&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https: http:</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">report-uri</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https://csp.withgoogle.com/csp/gws/other-hp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Date:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Fri, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">06</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Oct </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2023</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 03</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:43:46 GMT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Expires:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Sun, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">05</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Nov </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2023</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 03</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:43:46 GMT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Cache-Control:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> public, max-age=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2592000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Server:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> gws</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Content-Length:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 219</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">X-XSS-Protection:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">X-Frame-Options:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SAMEORIGIN</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">HTTP/1.1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 200</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Content-Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> text/html</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">charset</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ISO-8859-1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Content-Security-Policy-Report-Only:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> object-src &#39;none&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">base-uri</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;self&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">script-src</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;nonce-Ln-1anLLMO6ubPnv34o45g&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;strict-dynamic&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;report-sample&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;unsafe-eval&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;unsafe-inline&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https: http:</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">report-uri</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https://csp.withgoogle.com/csp/gws/other-hp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">P3P:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> CP=&quot;This is not a P3P policy! See g.co/p3phelp for more info.&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Date:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Fri, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">06</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Oct </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2023</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 03</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:43:46 GMT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Server:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> gws</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">X-XSS-Protection:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">X-Frame-Options:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SAMEORIGIN</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Transfer-Encoding:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> chunked</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Expires:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Fri, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">06</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Oct </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2023</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 03</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:43:46 GMT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Cache-Control:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> private</span></span></code></pre></div><p>发现正常了。这个时候我们开始重新安装。</p><h4 id="填充配置" tabindex="-1">填充配置 <a class="header-anchor" href="#填充配置" aria-label="Permalink to &quot;填充配置&quot;">​</a></h4><p>新的安装流程需要走 Helm，所以这里我们需要给 Cilium 的 Helm 部署参数配置一些额外信息来阻止 Cilium 使用 10.0.0.0/8 作为 CIDR，新建 <code>cilium-values-migration.yaml</code> 文件：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 默认打开 Hubble 的 Relay 和 UI，这样之后我们就不用再单独执行 cilium hubble enable 来启用了</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">hubble</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  relay</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  ui</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">ipam</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 可以阅读 https://docs.cilium.io/en/stable/network/concepts/ipam/kubernetes/ 了解更多</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  mode</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;kubernetes&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 此处的字面量需要和我们的 Kubernetes 在创建的时候指定的 Pod CIDR 相同</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    clusterPoolIPv4PodCIDRList</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;10.244.0.0/16&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 如果上面指定了 ipam.operator.clusterPoolIPv4PodCIDRList 那么这里就也得配置成一样的字面量</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">ipv4NativeRoutingCIDR</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;10.244.0.0/16&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 如果 tunnel 保持打开，而且我们卸载了 kube-proxy，那么需要开启下面的两个选项</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">enableIPv4Masquerade</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">enableIPv6Masquerade</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span></code></pre></div>`,10),K=s("code",null,"kubeProxyReplacement",-1),O=h('<blockquote><p>Cilium 的 kube-proxy 替换依赖于 socket-LB 功能，这需要 v4.19.57、v5.1.16、v5.2.0 或更高版本的 Linux 内核。 Linux 内核 v5.3 和 v5.8 添加了其他功能，Cilium 可以使用这些功能来进一步优化 kube-proxy 替换实现。 请注意，v5.0.y 内核没有运行 kube-proxy 替换所需的修复程序，因为此时 v5.0.y 稳定内核已终止生命 (EOL)，并且不再在内核上维护.org。对于单独的发行版维护的内核，情况可能有所不同。因此，请检查您的发行版。</p></blockquote><p>所以还请确保 <code>uname -a</code> 中输出的内核版本满足需求，如果不满足，可以注释或者删掉此行。</p><p>确认无误之后我们用下面的命令输出 Helm 安装用的配置文件：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium install --version </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2 --values cilium-values-migration.yaml --dry-run-helm-values</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-values-initial.yaml</span></span></code></pre></div>',4),M=h(`<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cat cilium-values-initial.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cluster:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  name:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubernetes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">enableIPv4Masquerade:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">enableIPv6Masquerade:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">hubble:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  relay:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    enabled:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ui:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    enabled:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ipam:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  mode:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubernetes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  operator:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    clusterPoolIPv4PodCIDRList:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ipv4NativeRoutingCIDR:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 注意确认一下 Kubernetes API Server 的 IP 是否是这个</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">k8sServiceHost:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> lb.kubesphere.local</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 注意确认一下 Kubernetes API Server 的端口是否是这个</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">k8sServicePort:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 6443</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubeProxyReplacement:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> strict</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">operator:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">serviceAccounts:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  cilium:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    name:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  operator:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    name:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-operator</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">tunnel:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> vxlan</span></span></code></pre></div><h4 id="移除原本的-kube-proxy" tabindex="-1">移除原本的 <code>kube-proxy</code> <a class="header-anchor" href="#移除原本的-kube-proxy" aria-label="Permalink to &quot;移除原本的 \`kube-proxy\`&quot;">​</a></h4>`,2),G=s("code",null,"kubeProxyReplacement",-1),H=s("code",null,"kube-proxy",-1),L=s("code",null,"kube-proxy",-1),$=s("code",null,"kube-proxy",-1),V=h(`<h4 id="安装-cilium-2" tabindex="-1">安装 Cilium <a class="header-anchor" href="#安装-cilium-2" aria-label="Permalink to &quot;安装 Cilium&quot;">​</a></h4><p>如果你还没有添加 Cilium 的 Repo，可以加一下：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> helm repo add cilium https://helm.cilium.io/</span></span></code></pre></div><p>然后安装：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> helm install cilium cilium/cilium --namespace kube-system --values cilium-values-initial.yaml</span></span></code></pre></div><p>然后我们再等等看：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo cilium status --wait</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    /¯¯\\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">_/¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Cilium:             OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Operator:           OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> /¯¯\\__/¯¯\\</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Envoy DaemonSet:    disabled </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> embedded mode</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Hubble Relay:       OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    \\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       ClusterMesh:        disabled</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             cilium-operator    Desired: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, Ready: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1, Available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             hubble-ui          Desired: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, Ready: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1, Available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">DaemonSet</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">              cilium             Desired: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, Ready: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/3, Available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             hubble-relay       Desired: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">, Ready: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1, Available: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Containers:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            hubble-ui          Running: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-relay</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       Running: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             Running: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Running: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Pods:          </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/10 managed by Cilium</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Helm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> chart version:    </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.14</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Image</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> versions         cilium-operator    quay.io/cilium/operator-generic:v1.14.2@sha256:52f70250dea22e506959439a7c4ea31b10fe8375db62f5c27ab746e3a2af866d: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-ui</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          quay.io/cilium/hubble-ui:v0.12.0@sha256:1c876cfa1d5e35bc91e1025c9314f922041592a88b03313c22c1f97a5d2ba88f: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-ui</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          quay.io/cilium/hubble-ui-backend:v0.12.0@sha256:8a79a1aad4fc9c2aa2b3e4379af0af872a89fcec9d99e117188190671c66fc2e: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-relay</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       quay.io/cilium/hubble-relay:v1.14.2@sha256:a89030b31f333e8fb1c10d2473250399a1a537c27d022cd8becc1a65d1bef1d6: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             quay.io/cilium/cilium:v1.14.2@sha256:6263f3a3d5d63b267b538298dbeb5ae87da3efacf09a2c620446c873ba807d35: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span></span></code></pre></div><p>现在再来测试的话就是正常的了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo cilium connectivity test</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✅</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> All </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">42</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> tests </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">295</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> actions</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">successful, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> tests skipped, </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> scenarios skipped.</span></span></code></pre></div><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h2>`,10),U=s("h2",{id:"贡献者",tabindex:"-1"},[i("贡献者 "),s("a",{class:"header-anchor",href:"#贡献者","aria-label":'Permalink to "贡献者"'},"​")],-1),W=s("h2",{id:"文件历史",tabindex:"-1"},[i("文件历史 "),s("a",{class:"header-anchor",href:"#文件历史","aria-label":'Permalink to "文件历史"'},"​")],-1);function z(j,Q,X,Y,J,Z){const t=k("NolebasePageProperties"),n=k("VPNolebaseInlineLinkPreview"),e=k("NolebaseGitContributors"),p=k("NolebaseGitChangelog");return g(),d("div",null,[C,a(t),y,s("table",null,[o,s("tbody",null,[c,s("tr",null,[u,A,s("td",null,[a(n,{href:"https://v1-28.docs.kubernetes.io/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("https://v1-28.docs.kubernetes.io/")]),_:1})])]),s("tr",null,[E,m,s("td",null,[a(n,{href:"https://docs.docker.com/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("https://docs.docker.com/")]),_:1})])]),b,B,D,s("tr",null,[v,f,s("td",null,[a(n,{href:"https://docs.cilium.io/en/v1.14/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("https://docs.cilium.io/en/v1.14/")]),_:1})])]),s("tr",null,[_,q,s("td",null,[a(n,{href:"https://helm.sh/docs/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("https://helm.sh/docs/")]),_:1})])])])]),P,I,s("p",null,[i("根据 "),a(n,{href:"https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Cilium Quick Installation")]),_:1}),i(" 的要求运行：")]),x,s("p",null,[i("可以根据文档"),a(n,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/完全卸载使用 KubeKey 安装的 Calico.html"},{default:l(()=>[i("完全卸载使用 KubeKey 安装的 Calico")]),_:1}),i(" 中建议的方式和步骤来进行删除。")]),T,s("p",null,[i("我们重新翻阅文档 "),a(n,{href:"https://docs.cilium.io/en/stable/network/concepts/ipam/cluster-pool/#ipam-crd-cluster-pool",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Cluster Scope (Default) — Cilium 1.14.2 documentation")]),_:1}),i(": 可以发现文档中描述说：")]),S,s("p",null,[i("所以根据文档 "),a(n,{href:"https://docs.cilium.io/en/stable/installation/k8s-install-migration/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Migrating a cluster to Cilium — Cilium 1.14.2 documentation")]),_:1}),i(" 的说明，我们还需要在安装的时候额外配置一下 CIDR 才能解决这个问题。")]),R,w,s("p",null,[i("那我们现在先根据"),a(n,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/完全卸载使用 Helm 安装的 Cilium.html"},{default:l(()=>[i("完全卸载使用 Helm 安装的 Cilium")]),_:1}),i(" 文档的指引完全删除 cilium 然后再试一次。")]),N,s("p",null,[i("注意这个配置文件里面的 "),K,i(" 字段配置，根据 Cilium 的 "),a(n,{href:"https://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/#kubeproxy-free",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Kubernetes Without kube-proxy")]),_:1}),i(" 文档：")]),O,s("p",null,[i("可以通过 "),a(n,{href:"/笔记/📟 终端/Linux 命令/文档读写/cat 输出文件.html"},{default:l(()=>[i("cat 输出文件")]),_:1}),i(" 命令检查一下：")]),M,s("p",null,[i("::: tips 如果你选择使用 "),G,i(" 参数替代 "),H,i(" 可以跟随"),a(n,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/完全卸载集群内的 `kube-proxy`.html"},{default:l(()=>[i("完全卸载集群内的 "),L]),_:1}),i(" 文档的指引备份和删除 "),$,i(" 相关的配置和资源。 :::")]),V,s("ul",null,[s("li",null,[a(n,{href:"https://tinychen.com/20230201-k8s-15-migrate-cni-from-calico-to-cilium/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("k8s系列15-calico有损迁移至cilium - TinyChen's Studio - 互联网技术学习工作经验分享")]),_:1})]),s("li",null,[a(n,{href:"https://github.com/kubernetes/kubernetes/issues/86762",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("coredns [ERROR] plugin/errors: 2 read udp 10.244.235.249:55567->10.96.0.10:53: i/o timeout · Issue #86762 · kubernetes/kubernetes")]),_:1})]),s("li",null,[a(n,{href:"https://github.com/kubernetes/kubernetes/issues/111105",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("When using cilium as Kubernetes network CNI, the coredns is running but not-ready, healthcheck failed and plugin/errors HINFO: read udp i/o timeout · Issue #111105 · kubernetes/kubernetes")]),_:1})]),s("li",null,[a(n,{href:"https://izsk.me/2023/06/03/cilium-on-kubernetes-install/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("cilium在kubernetes中的生产实践二(cilium部署) | Z.S.K.'s Records")]),_:1})]),s("li",null,[a(n,{href:"https://isovalent.com/blog/post/tutorial-migrating-to-cilium-part-1/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Tutorial: How to Migrate to Cilium (Part 1) - Isovalent")]),_:1})]),s("li",null,[a(n,{href:"https://kubernetes.feisky.xyz/extension/network/cilium",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Cilium - Kubernetes指南")]),_:1})]),s("li",null,[a(n,{href:"https://github.com/kubernetes/kubernetes/issues/86762",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("coredns [ERROR] plugin/errors: 2 read udp 10.244.235.249:55567->10.96.0.10:53: i/o timeout · Issue #86762 · kubernetes/kubernetes")]),_:1})]),s("li",null,[a(n,{href:"https://github.com/cilium/cilium/issues/13308",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("DNS rules don't work anymore on kubernetes 1.18 with cilium 1.8 · Issue #13308 · cilium/cilium")]),_:1})]),s("li",null,[a(n,{href:"https://github.com/cilium/cilium/issues/23872",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("I set ipam.operator.clusterPoolIPv4PodCIDR=10.1.0.0/16 why the pod ip allocated is still 10.0 · Issue #23872 · cilium/cilium")]),_:1})]),s("li",null,[a(n,{href:"https://github.com/kubernetes/kubernetes/issues/111105",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("When using cilium as Kubernetes network CNI, the coredns is running but not-ready, healthcheck failed and plugin/errors HINFO: read udp i/o timeout · Issue #111105 · kubernetes/kubernetes")]),_:1})]),s("li",null,[a(n,{href:"https://serverfault.com/questions/1103034/kubernetes-nodes-are-not-reachable-and-cannot-reach-local-network-after-installi",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("linux - Kubernetes Nodes are not reachable and cannot reach local network after installing cilium - Server Fault")]),_:1})]),s("li",null,[a(n,{href:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Creating a cluster with kubeadm | Kubernetes")]),_:1})]),s("li",null,[a(n,{href:"https://stackoverflow.com/questions/49112336/container-runtime-network-not-ready-cni-config-uninitialized",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("kubernetes - Container runtime network not ready: cni config uninitialized - Stack Overflow")]),_:1})]),s("li",null,[a(n,{href:"https://www.jianshu.com/p/896ec00b9661",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("删除cilium ebpf/bpf程序/完全卸载cilium")]),_:1})]),s("li",null,[a(n,{href:"https://gist.github.com/aliasmee/6c7e5fb433c8fd303b07f0081fc83677",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("无法彻底清理cilium留下的问题")]),_:1})]),s("li",null,[a(n,{href:"https://www.chenshaowen.com/blog/how-to-use-cilium-to-replace-calico.html",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("使用 Cilium 替换 Calico – 陈少文的网站")]),_:1})]),s("li",null,[a(n,{href:"https://kubernetes.io/docs/tasks/debug/debug-cluster/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Troubleshooting Clusters | Kubernetes")]),_:1})])]),U,a(e),W,a(p)])}const as=r(F,[["render",z]]);export{is as __pageData,as as default};
