import{_ as k,c as r,J as a,m as s,a as i,w as n,V as d,E as t,o}from"./chunks/framework.WH0rnJL5.js";const x=JSON.parse('{"title":"配置 mTLS","description":"","frontmatter":{"tags":["计算机/网络/网关/Nginx","数学/密码学/证书/TLS/SSL","数学/密码学/证书/TLS","数学/密码学/证书/证书机构","数学/密码学/证书/证书机构/CA","数学/密码学/证书/p12","计算机/信息技术/安全/网络安全/ZTNA","计算机/信息技术/安全/操作系统安全/KeyStore","数学/密码学/证书/PKI","命令行/openssl","数学/密码学/证书/TLS/mTLS"]},"headers":[],"relativePath":"笔记/🔒 PKI 公钥基础设施/TLS 传输层安全/mTLS/配置 mTLS.md","filePath":"笔记/🔒 PKI 公钥基础设施/TLS 传输层安全/mTLS/配置 mTLS.md"}'),c={name:"笔记/🔒 PKI 公钥基础设施/TLS 传输层安全/mTLS/配置 mTLS.md"},g=s("h1",{id:"配置-mtls",tabindex:"-1"},[i("配置 mTLS "),s("a",{class:"header-anchor",href:"#配置-mtls","aria-label":'Permalink to "配置 mTLS"'},"​")],-1),y=d(`<h2 id="创建-ca-证书颁发机构" tabindex="-1">创建 CA（证书颁发机构） <a class="header-anchor" href="#创建-ca-证书颁发机构" aria-label="Permalink to &quot;创建 CA（证书颁发机构）&quot;">​</a></h2><h3 id="创建根证书颁发机构的私钥并使用-des3-加密模式进行加密" tabindex="-1">创建根证书颁发机构的私钥并使用 des3 加密模式进行加密 <a class="header-anchor" href="#创建根证书颁发机构的私钥并使用-des3-加密模式进行加密" aria-label="Permalink to &quot;创建根证书颁发机构的私钥并使用 des3 加密模式进行加密&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> genrsa -des3 -out ca.pem </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4096</span></span></code></pre></div><h3 id="创建根证书颁发机构的证书申请" tabindex="-1">创建根证书颁发机构的证书申请 <a class="header-anchor" href="#创建根证书颁发机构的证书申请" aria-label="Permalink to &quot;创建根证书颁发机构的证书申请&quot;">​</a></h3><p>此处申请了 18250 天（50 年）的根证书</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> req -x509 -new -nodes -key ca.pem -sha256 -days </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">18250</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> -out ca.crt</span></span></code></pre></div><h4 id="填写字段值" tabindex="-1">填写字段值 <a class="header-anchor" href="#填写字段值" aria-label="Permalink to &quot;填写字段值&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Enter</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pass phrase for myCA.key:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">You</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are about to be asked to enter information that will be incorporated</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">into</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> your certificate request.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">What</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> you are about to enter is what is called a Distinguished Name or a DN.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">There</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are quite a few fields but you can leave some blank</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">For</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> some fields there will be a default value,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">If</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> you enter &#39;.&#39;, the field will be left blank.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">-----</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Country</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> letter code</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) [AU]: CN </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 国家代码</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">State</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> or Province Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">full</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) [Some-State]: Shanghai </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 省份/州名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">State</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Locality Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">eg,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> city</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) []: Shanghai </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 所在城市名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Organization</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">eg,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> company</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) [Internet </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">Widgits Pty Ltd]: Ayaka iHome # 此处输入组织名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Organizational</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Unit Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">eg,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> section</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) []: Home </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 此处输入部门名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Common</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">e.g.</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> server FQDN or YOUR name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) []: Ayaka iHome Root CA </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 此处输入证书名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Email</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Address []:neko@ayaka.moe # 此处输入 Root CA 管理员电子邮箱</span></span></code></pre></div><h3 id="创建根证书颁发机构的配置文件并写入策略和拓展信息" tabindex="-1">创建根证书颁发机构的配置文件并写入策略和拓展信息 <a class="header-anchor" href="#创建根证书颁发机构的配置文件并写入策略和拓展信息" aria-label="Permalink to &quot;创建根证书颁发机构的配置文件并写入策略和拓展信息&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;[ ca ]</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"># \`man ca\`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">default_ca = CA_default</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">[ CA_default ]</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">dir           = /Users/neko/certs/home</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">private_key   = $dir/home_ca.pem</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">certificate   = $dir/home_ca.crt</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">database      = $dir/index.txt</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">new_certs_dir = $dir/certs</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">serial        = $dir/serial</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">policy        = policy_loose</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">[ policy_loose ]</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">countryName             = optional</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">stateOrProvinceName     = optional</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">localityName            = optional</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">organizationName        = optional</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">organizationalUnitName  = optional</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">commonName              = supplied</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">emailAddress            = optional</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">[ v3_intermediate_ca ]</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"># Extensions for a typical intermediate CA (\`man x509v3_config\`).</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">subjectKeyIdentifier = hash</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">authorityKeyIdentifier = keyid:always,issuer</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">basicConstraints = critical, CA:true, pathlen:0</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">keyUsage = critical, digitalSignature, cRLSign, keyCertSign</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./home_ca.cnf</span></span></code></pre></div><h2 id="创建-intermediate-ca-中间证书颁发机构" tabindex="-1">创建 Intermediate CA（中间证书颁发机构） <a class="header-anchor" href="#创建-intermediate-ca-中间证书颁发机构" aria-label="Permalink to &quot;创建 Intermediate CA（中间证书颁发机构）&quot;">​</a></h2><h3 id="创建中间证书颁发机构的私钥并使用-des3-加密模式进行加密" tabindex="-1">创建中间证书颁发机构的私钥并使用 des3 加密模式进行加密 <a class="header-anchor" href="#创建中间证书颁发机构的私钥并使用-des3-加密模式进行加密" aria-label="Permalink to &quot;创建中间证书颁发机构的私钥并使用 des3 加密模式进行加密&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> genrsa -des3 -out intermediates/home_ca_intermediate_1.pem </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4096</span></span></code></pre></div><h3 id="创建中间证书颁发机构的证书申请" tabindex="-1">创建中间证书颁发机构的证书申请 <a class="header-anchor" href="#创建中间证书颁发机构的证书申请" aria-label="Permalink to &quot;创建中间证书颁发机构的证书申请&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> req -new -sha256 -key intermediates/home_ca_intermediate_1.pem -out intermediates/home_ca_intermediate_1.csr</span></span></code></pre></div><h3 id="使用根证书颁发机构对中间证书颁发机构进行签发" tabindex="-1">使用根证书颁发机构对中间证书颁发机构进行签发 <a class="header-anchor" href="#使用根证书颁发机构对中间证书颁发机构进行签发" aria-label="Permalink to &quot;使用根证书颁发机构对中间证书颁发机构进行签发&quot;">​</a></h3><p>此处使用了先前创建并写入的 <code>home_ca.cnf</code> 配置文件，开启了配置文件中写入的 <code>v3_intermediate_ca</code> 拓展</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ca -config home_ca.cnf -extensions v3_intermediate_ca -days </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3650</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> -notext -md sha256 -in intermediates/home_ca_intermediate_1.csr -out intermediates/home_ca_intermediate_1.crt</span></span></code></pre></div><h3 id="使用根证书颁发机构对中间证书颁发机构进行验证测试" tabindex="-1">使用根证书颁发机构对中间证书颁发机构进行验证测试 <a class="header-anchor" href="#使用根证书颁发机构对中间证书颁发机构进行验证测试" aria-label="Permalink to &quot;使用根证书颁发机构对中间证书颁发机构进行验证测试&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> verify -CAfile home_ca.crt intermediates/home_ca_intermediate_1.crt</span></span></code></pre></div><p>应该输出</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">intermediates/home_ca_intermediate_1.crt:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> OK</span></span></code></pre></div><h2 id="创建客户端证书" tabindex="-1">创建客户端证书 <a class="header-anchor" href="#创建客户端证书" aria-label="Permalink to &quot;创建客户端证书&quot;">​</a></h2><h3 id="创建客户端用户的私钥并使用-des3-加密模式进行加密" tabindex="-1">创建客户端用户的私钥并使用 des3 加密模式进行加密 <a class="header-anchor" href="#创建客户端用户的私钥并使用-des3-加密模式进行加密" aria-label="Permalink to &quot;创建客户端用户的私钥并使用 des3 加密模式进行加密&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> genrsa -des3 -out clients/neko.pem </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">4096</span></span></code></pre></div><h3 id="创建证书申请" tabindex="-1">创建证书申请 <a class="header-anchor" href="#创建证书申请" aria-label="Permalink to &quot;创建证书申请&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> req -new -key clients/neko.pem -out clients/neko.csr</span></span></code></pre></div><h4 id="填写字段值-1" tabindex="-1">填写字段值 <a class="header-anchor" href="#填写字段值-1" aria-label="Permalink to &quot;填写字段值&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Enter</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pass phrase for clients/neko.pem:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">You</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are about to be asked to enter information that will be incorporated</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">into</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> your certificate request.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">What</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> you are about to enter is what is called a Distinguished Name or a DN.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">There</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are quite a few fields but you can leave some blank</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">For</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> some fields there will be a default value,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">If</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> you enter &#39;.&#39;, the field will be left blank.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">-----</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Country</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> letter code</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) []:CN </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 国家代码</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">State</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> or Province Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">full</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) []:Shanghai </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 省份/州名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Locality</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">eg,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> city</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) []:Shanghai </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 所在城市名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Organization</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">eg,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> company</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) []:Ayaka Home Users </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 此处输入组织名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Organizational</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Unit Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">eg,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> section</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) []:Users </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 此处输入部门名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Common</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">eg,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fully qualified host name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) []:neko@ayaka.moe </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 此处输入证书名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Email</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Address []:neko@ayaka.moe # 此处输入授权的电子邮箱账号</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Please</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> enter the following &#39;extra&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> attributes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> be sent with your certificate request</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">A</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> challenge password []:</span></span></code></pre></div><h3 id="配置证书类型并使用-ca-证书和私钥进行证书签发" tabindex="-1">配置证书类型并使用 CA 证书和私钥进行证书签发 <a class="header-anchor" href="#配置证书类型并使用-ca-证书和私钥进行证书签发" aria-label="Permalink to &quot;配置证书类型并使用 CA 证书和私钥进行证书签发&quot;">​</a></h3><h4 id="配置证书类型" tabindex="-1">配置证书类型 <a class="header-anchor" href="#配置证书类型" aria-label="Permalink to &quot;配置证书类型&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;basicConstraints = CA:FALSE</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">nsCertType = client, email</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">nsComment = &quot;Ayaka Home Users Certificates&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">subjectKeyIdentifier = hash</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">authorityKeyIdentifier = keyid,issuer</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">keyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">extendedKeyUsage = clientAuth, emailProtection</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> clients/neko.cnf</span></span></code></pre></div><h4 id="证书签发" tabindex="-1">证书签发 <a class="header-anchor" href="#证书签发" aria-label="Permalink to &quot;证书签发&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> x509 -req -days </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">365</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> -sha256 -extfile clients/neko.cnf -in clients/neko.csr -CA home_ca.crt -CAkey home_ca.pem -out clients/neko.crt -CAcreateserial</span></span></code></pre></div><h3 id="创建证书链-bundle" tabindex="-1">创建证书链 bundle <a class="header-anchor" href="#创建证书链-bundle" aria-label="Permalink to &quot;创建证书链 bundle&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> home_ca.crt intermediates/home_ca_intermediate_1.crt</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/home_ca_intermediate_1_bundle.crt</span></span></code></pre></div><h3 id="使用证书链-bundle-来为客户端证书进行验证测试" tabindex="-1">使用证书链 bundle 来为客户端证书进行验证测试 <a class="header-anchor" href="#使用证书链-bundle-来为客户端证书进行验证测试" aria-label="Permalink to &quot;使用证书链 bundle 来为客户端证书进行验证测试&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> verify -CAfile intermediates/home_ca_intermediate_1_bundle.crt clients/neko.crt</span></span></code></pre></div><p>应该输出</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">clients/neko.crt:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> OK</span></span></code></pre></div><h3 id="将用户证书打包为-pfx-p12-格式的文件方便导入导出" tabindex="-1">将用户证书打包为 .pfx/.p12 格式的文件方便导入导出 <a class="header-anchor" href="#将用户证书打包为-pfx-p12-格式的文件方便导入导出" aria-label="Permalink to &quot;将用户证书打包为 .pfx/.p12 格式的文件方便导入导出&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pkcs12 -export -out clients/neko.p12 -inkey clients/neko.pem -in clients/neko.crt</span></span></code></pre></div><h2 id="配置-nginx-进行-mtls-验证" tabindex="-1">配置 Nginx 进行 mTLS 验证 <a class="header-anchor" href="#配置-nginx-进行-mtls-验证" aria-label="Permalink to &quot;配置 Nginx 进行 mTLS 验证&quot;">​</a></h2><h3 id="将证书链-bundle-上传并配置到-nginx-目录下" tabindex="-1">将证书链 bundle 上传并配置到 Nginx 目录下 <a class="header-anchor" href="#将证书链-bundle-上传并配置到-nginx-目录下" aria-label="Permalink to &quot;将证书链 bundle 上传并配置到 Nginx 目录下&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">scp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/home_ca_intermediate_1.pem host:~/</span></span></code></pre></div><h4 id="创建-client-certs-目录" tabindex="-1">创建 <code>client_certs</code> 目录 <a class="header-anchor" href="#创建-client-certs-目录" aria-label="Permalink to &quot;创建 \`client_certs\` 目录&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mkdir -p /etc/nginx/client_certs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> chmod </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">600</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /etc/nginx/client_certs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> chmod </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">600</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> -R /etc/nginx/client_certs</span></span></code></pre></div><p>移动证书链 bundle 到 <code>client_certs</code> 目录下</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mv ~/home_ca_intermediate_1_bundle.crt ./</span></span></code></pre></div><h3 id="更新-nginx-配置文件" tabindex="-1">更新 Nginx 配置文件 <a class="header-anchor" href="#更新-nginx-配置文件" aria-label="Permalink to &quot;更新 Nginx 配置文件&quot;">​</a></h3><p>在需要添加 mTLS 验证的服务配置中添加下面的几行</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 添加 ssl_client_certificate 参数配置，填写 证书链 bundle 的路径</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    ssl_client_certificate </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">/etc/nginx/client_certs/home_ca_intermediate_1_bundle.crt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 添加 ssl_verify_client 参数配置，填写为 optional。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 注：该参数配置支持三个值，分别是：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 1. on: 强制 TLS 证书验证，不满足时拒绝连接;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 2. optional: 不强制 TLS 证书验证，将结果返回到 Nginx 上下文 ssl_client_verify 变量中;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 3. off; 关闭 TLS 证书验证。</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    ssl_verify_client </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">     optional;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> / </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        # 进行 if 判断，对 TLS 客户端证书验证结果进行判断，如果验证不成功，则返回 496 错误代码</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ($</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">ssl_client_verify</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> != </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">SUCCESS) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 496</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">          ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><h3 id="测试-nginx-配置文件" tabindex="-1">测试 Nginx 配置文件 <a class="header-anchor" href="#测试-nginx-配置文件" aria-label="Permalink to &quot;测试 Nginx 配置文件&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nginx -t</span></span></code></pre></div><h3 id="重载-nginx-配置" tabindex="-1">重载 Nginx 配置 <a class="header-anchor" href="#重载-nginx-配置" aria-label="Permalink to &quot;重载 Nginx 配置&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nginx -s reload</span></span></code></pre></div><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h2>`,57),F=s("h2",{id:"延伸阅读",tabindex:"-1"},[i("延伸阅读 "),s("a",{class:"header-anchor",href:"#延伸阅读","aria-label":'Permalink to "延伸阅读"'},"​")],-1),u=s("h2",{id:"贡献者",tabindex:"-1"},[i("贡献者 "),s("a",{class:"header-anchor",href:"#贡献者","aria-label":'Permalink to "贡献者"'},"​")],-1),C=s("h2",{id:"文件历史",tabindex:"-1"},[i("文件历史 "),s("a",{class:"header-anchor",href:"#文件历史","aria-label":'Permalink to "文件历史"'},"​")],-1);function m(b,f,A,_,v,E){const l=t("NolebasePageProperties"),e=t("VPNolebaseInlineLinkPreview"),h=t("NolebaseGitContributors"),p=t("NolebaseGitChangelog");return o(),r("div",null,[g,a(l),s("p",null,[i("本文章着重参考了 "),a(e,{href:"https://jamielinux.com/docs/openssl-certificate-authority/introduction.html",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("OpenSSL Certificate Authority — Jamie Nguyen")]),_:1}),i(" 一站的文章说明和讲解。")]),y,s("p",null,[a(e,{href:"https://gist.github.com/yidas/af42d2952d85c0951c1722fcd68716c6",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("Certificate(CSR) configuration file")]),_:1})]),s("p",null,[a(e,{href:"https://www.phildev.net/ssl/creating_ca.html",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("Creating a CA")]),_:1})]),s("p",null,[a(e,{href:"https://unix.stackexchange.com/questions/398280/openssl-basic-configuration-new-certs-dir-certs",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("OpenSSL, basic configuration, new_certs_dir, certs - Unix & Linux Stack Exchange")]),_:1})]),s("p",null,[a(e,{href:"https://dadhacks.org/2017/12/27/building-a-root-ca-and-an-intermediate-ca-using-openssl-and-debian-stretch/",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("Building a Root CA and an Intermediate CA using OpenSSL and Debian Stretch | Dad Hacks")]),_:1})]),s("p",null,[a(e,{href:"https://www.jianshu.com/p/b92d4c8cbe05",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("openssl生成https自签名证书 - 简书")]),_:1})]),s("p",null,[a(e,{href:"https://jamielinux.com/docs/openssl-certificate-authority/create-the-intermediate-pair.html",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("Create the intermediate pair — OpenSSL Certificate Authority — Jamie Nguyen")]),_:1})]),s("p",null,[a(e,{href:"https://www.golinuxcloud.com/create-certificate-authority-root-ca-linux/",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("Create Certificate Authority and sign a certificate with Root CA | GoLinuxCloud")]),_:1})]),s("p",null,[a(e,{href:"https://www.golinuxcloud.com/openssl-create-client-server-certificate/",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("OpenSSL create client certificate & server certificate with example | GoLinuxCloud")]),_:1})]),s("p",null,[a(e,{href:"https://apfelboymchen.net/gnu/notes/openssl%20multidomain%20with%20config%20files.html",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("How to create multidomain certificates using config files")]),_:1})]),s("p",null,[a(e,{href:"https://smallstep.com/hello-mtls/doc/server/nginx",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("Configuring Your Nginx Server for Mutual TLS — Smallstep")]),_:1})]),s("p",null,[a(e,{href:"https://tweenpath.net/convert-p12-bundle-to-server-certificate-and-key-files/",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("Convert .p12 bundle to server certificate and key files | Bots!")]),_:1})]),F,s("p",null,[a(e,{href:"https://smallstep.com/hello-mtls/doc/server/nginx",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("Nginx 的简单 mTLS 配置 - smallstep")]),_:1})]),s("p",null,[a(e,{href:"https://www.nginx.com/blog/mtls-architecture-nginx-service-mesh/",target:"_blank",rel:"noreferrer"},{default:n(()=>[i("Nginx 服务网格中的 mTLS 架构 - Nginx")]),_:1})]),u,a(h),C,a(p)])}const q=k(c,[["render",m]]);export{x as __pageData,q as default};
