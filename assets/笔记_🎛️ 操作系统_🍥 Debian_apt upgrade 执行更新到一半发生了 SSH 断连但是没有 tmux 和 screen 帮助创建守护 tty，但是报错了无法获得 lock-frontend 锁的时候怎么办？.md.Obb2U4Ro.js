import{_ as d,c as k,J as i,m as s,a,w as n,V as p,E as e,o as r}from"./chunks/framework.WH0rnJL5.js";const c="/assets/during-apt-upgrading-ssh-broken-pipe-and-no-tty-wrapper-what-to-do-screenshot-1.91GmHMzi.png",T=JSON.parse('{"title":"apt upgrade 执行更新到一半发生了 SSH 断连但是没有 tmux 和 screen 帮助创建守护 tty，但是报错了无法获得 lock-frontend 锁的时候怎么办？","description":"","frontmatter":{"tags":["计算机/操作系统/Linux","操作系统/Linux","操作系统/Debian","操作系统/Debian/Debian-11","操作系统/Unix","命令行/apt","运维","命令行/ssh","命令行/终端","开发/故障排查"]},"headers":[],"relativePath":"笔记/🎛️ 操作系统/🍥 Debian/apt upgrade 执行更新到一半发生了 SSH 断连但是没有 tmux 和 screen 帮助创建守护 tty，但是报错了无法获得 lock-frontend 锁的时候怎么办？.md","filePath":"笔记/🎛️ 操作系统/🍥 Debian/apt upgrade 执行更新到一半发生了 SSH 断连但是没有 tmux 和 screen 帮助创建守护 tty，但是报错了无法获得 lock-frontend 锁的时候怎么办？.md"}'),g={name:"笔记/🎛️ 操作系统/🍥 Debian/apt upgrade 执行更新到一半发生了 SSH 断连但是没有 tmux 和 screen 帮助创建守护 tty，但是报错了无法获得 lock-frontend 锁的时候怎么办？.md"},u=s("h1",{id:"apt-upgrade-执行更新到一半发生了-ssh-断连但是没有-tmux-和-screen-帮助创建守护-tty-但是报错了无法获得-lock-frontend-锁的时候怎么办",tabindex:"-1"},[s("code",null,"apt upgrade"),a(" 执行更新到一半发生了 SSH 断连但是没有 "),s("code",null,"tmux"),a(" 和 "),s("code",null,"screen"),a(" 帮助创建守护 "),s("code",null,"tty"),a("，但是报错了无法获得 "),s("code",null,"lock-frontend"),a(" 锁的时候怎么办？ "),s("a",{class:"header-anchor",href:"#apt-upgrade-执行更新到一半发生了-ssh-断连但是没有-tmux-和-screen-帮助创建守护-tty-但是报错了无法获得-lock-frontend-锁的时候怎么办","aria-label":'Permalink to "`apt upgrade` 执行更新到一半发生了 SSH 断连但是没有 `tmux` 和 `screen` 帮助创建守护 `tty`，但是报错了无法获得 `lock-frontend` 锁的时候怎么办？"'},"​")],-1),_=p('<h2 id="tl-dr" tabindex="-1">TL;DR <a class="header-anchor" href="#tl-dr" aria-label="Permalink to &quot;TL;DR&quot;">​</a></h2><p>确认是不是 <code>apt</code> 造成的锁文件</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> lsof /var/lib/dpkg/lock-frontend</span></span></code></pre></div><p>如果是的话，一般而言这个时候 <code>apt</code> 进程已经不会再继续执行了，最好执行一次系统备份和快照。</p><p>然后重启</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> reboot</span></span></code></pre></div><p>执行</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dpkg --configure -a</span></span></code></pre></div><p>来恢复和继续更新会话。</p><h2 id="背景" tabindex="-1">背景 <a class="header-anchor" href="#背景" aria-label="Permalink to &quot;背景&quot;">​</a></h2><p>这是一个很有意思的问题：</p><p><img src="'+c+`" alt=""></p><p>我之前在滚更新的时候离开了电脑，结果更新的途中弹窗提示并且 hold 住了整个更新，结果跑 SSH 连接去更新的设备和远端服务器的连接故障了，发生了 Broken Pipe，而且我还没有开 <code>tmux</code> 和 <code>screen</code> 去维持住 <code>tty</code>。</p><p>这个时候如果你重新登录到 SSH 之后尝试再次运行 <code>apt upgrade</code> 的时候其实会遇到这样的事情</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo apt upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">正在等待缓存锁：无法获得锁</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /var/lib/dpkg/lock-frontend。锁正由进程 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">8168</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">（apt）持有</span></span></code></pre></div><p>或者在英文里是这样的</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo apt upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Waiting</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for cache lock: Could not get lock /var/lib/dpkg/lock-frontend. It is held by process </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">8168</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span></code></pre></div>`,17),F=p(`<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">dpkg</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --configure</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --pending</span></span></code></pre></div><p>来配置正在过程中的 <code>apt</code> 事务操作，但是你很可能会直接遇到报错说遇到了锁：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo dpkg --configure --pending</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">dpkg:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 错误: dpkg 前端锁 已被另一个 pid 为 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">8168</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 的进程加锁</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">注意：删除锁文件的操作是错误的，这样操作会损坏上锁的部分甚至损坏</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">个系统。详情请见</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">https://wiki.debian.org/Teams/Dpkg/FA</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">Q</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">。</span></span></code></pre></div><p>或者在英文里是这样的</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo dpkg --configure --pending</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">dpkg:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> error: dpkg frontend lock was locked by another process with pid </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">8168</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Note:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> removing the lock file is always wrong, and can end up damaging the</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">locked</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> area and the entire system. See </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">https://wiki.debian.org/Teams/Dpkg/FA</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">Q</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.</span></span></code></pre></div><p>好的，那怎么解决？</p><h2 id="解决" tabindex="-1">解决 <a class="header-anchor" href="#解决" aria-label="Permalink to &quot;解决&quot;">​</a></h2><p>我们当然不可以直接去删掉 <code>/var/lib/dpkg/lock-frontend</code>！因为如果删掉了，可能会有别的脚本和命令会开始抢夺，造成意外之外的更新，甚至破坏整个系统。比如如果设定了 <code>systemd-timer</code> 来自动更新系统，那这个时候可能会出现系统直接被触发的 timer 更新的情况。</p><p>首先这个 pid 8168 可以通过下面的命令来获得：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> lsof /var/lib/dpkg/lock-frontend</span></span></code></pre></div><p>你也可以通过</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ps -A </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> apt</span></span></code></pre></div><p>来查找到对应的进程信息。找到和确认了造成锁的僵死的 <code>apt</code> 进程之后，你也可以通过 <code>top</code>、<code>btop</code>、<code>htop</code> 这样的命令来观察这个僵死的 <code>apt</code> 的资源消耗，当然，实际上，即便是对于系统更新而言，一般而言这个时候 <code>apt</code> 进程已经不会再继续执行了<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。</p><p>这意味着你完全可以在其他系统上正在进行的工作完成收尾和备份完成后先执行重启</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> reboot</span></span></code></pre></div><p>然后在重新登录的时候就可以先执行一次</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> apt upgrade</span></span></code></pre></div><p>来试图重新更新，很有可能你会获得下面的错误和提示</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo apt upgrade</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[sudo] neko 的密码：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">E:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dpkg 被中断，您必须手工运行 ‘sudo dpkg --configure -a’ 解决此问题。</span></span></code></pre></div><p>而这个 <code>sudo dpkg --configure -a</code> 恰好就是我们最终会需要的命令。</p><p>接下来最后我们执行</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dpkg --configure -a</span></span></code></pre></div><p>就可以继续我们之前被打断的 <code>apt</code> 了。</p><h2 id="贡献者" tabindex="-1">贡献者 <a class="header-anchor" href="#贡献者" aria-label="Permalink to &quot;贡献者&quot;">​</a></h2>`,24),y=s("h2",{id:"文件历史",tabindex:"-1"},[a("文件历史 "),s("a",{class:"header-anchor",href:"#文件历史","aria-label":'Permalink to "文件历史"'},"​")],-1),C=s("hr",{class:"footnotes-sep"},null,-1),b={class:"footnotes"},v={class:"footnotes-list"},m={id:"fn1",class:"footnote-item"},f=s("a",{href:"#fnref1",class:"footnote-backref"},"↩︎",-1);function A(E,B,S,x,D,P){const l=e("NolebasePageProperties"),t=e("VPNolebaseInlineLinkPreview"),h=e("NolebaseGitContributors"),o=e("NolebaseGitChangelog");return r(),k("div",null,[u,i(l),_,s("p",null,[a("一般而言如果直接参考 Debian 的文档 "),i(t,{href:"https://wiki.debian.org/Teams/Dpkg/FAQ#Q:_What_can_be_done_when_the_dpkg_lock_is_held.3F",target:"_blank",rel:"noreferrer"},{default:n(()=>[a("Q: What can be done when the dpkg lock is held?")]),_:1}),a(" 的话，会要求执行")]),F,i(h),y,i(o),C,s("section",b,[s("ol",v,[s("li",m,[s("p",null,[i(t,{href:"https://unix.stackexchange.com/questions/156541/ssh-pipe-broke-while-running-apt-upgrade-what-can-i-do-about-it",target:"_blank",rel:"noreferrer"},{default:n(()=>[a("debian - SSH pipe broke while running apt upgrade. What can I do about it? - Unix & Linux Stack Exchange")]),_:1}),a(),f])])])])])}const N=d(g,[["render",A]]);export{T as __pageData,N as default};
